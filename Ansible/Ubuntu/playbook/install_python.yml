---
# Ansible Playbook: Install Python
# Description: Installs specified Python version with pip
# Target: Ubuntu servers

- name: Install Python
  hosts: ubuntu
  become: true
  gather_facts: true

  vars:
    python_version: "3.13"

  tasks:
    - name: Install software-properties-common
      apt:
        name: software-properties-common
        state: present
        update_cache: yes
      tags: ['python']

    - name: Add deadsnakes PPA
      apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present
        update_cache: yes
      tags: ['python']

    - name: Install Python {{ python_version }}
      apt:
        name:
          - python{{ python_version }}
          - python{{ python_version }}-venv
        state: present
      tags: ['python']

    - name: Download get-pip.py
      get_url:
        url: https://bootstrap.pypa.io/get-pip.py
        dest: /tmp/get-pip.py
        mode: '0755'
      tags: ['python']

    - name: Install pip for Python {{ python_version }}
      command: python{{ python_version }} /tmp/get-pip.py --ignore-installed
      register: pip_install
      changed_when: "'Successfully installed' in pip_install.stdout"
      failed_when: false
      tags: ['python']

    - name: Clean up get-pip.py
      file:
        path: /tmp/get-pip.py
        state: absent
      tags: ['python']

    - name: Update alternatives for python
      alternatives:
        name: python
        path: /usr/bin/python{{ python_version }}
        link: /usr/bin/python
        priority: 100
      tags: ['python']

    - name: Update alternatives for pip
      alternatives:
        name: pip
        path: /usr/local/bin/pip{{ python_version }}
        link: /usr/bin/pip
        priority: 100
      tags: ['python']

    - name: Verify installation
      command: python --version
      register: python_output
      changed_when: false
      tags: ['python']

    - name: Display Python version
      debug:
        msg: "{{ python_output.stdout }}"
      tags: ['python']
