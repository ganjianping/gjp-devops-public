---
# Ansible Playbook: Install MariaDB 12.2
# Description: Installs MariaDB 12.2 on Ubuntu servers using the official MariaDB repository
# Target: Ubuntu servers
# Requirements: Ubuntu 20.04 / 22.04 / 24.04

- name: Install MariaDB 12.2
  hosts: ubuntu
  become: true
  gather_facts: true

  vars:
    mariadb_version: "12.2"
    mariadb_root_password: "root2026!"
    mariadb_admin_user: "admin"
    mariadb_admin_password: "admin2026!"
    mariadb_bind_address: "0.0.0.0"
    mariadb_port: 3306

  tasks:
    - name: Update apt cache
      command: apt-get update
      changed_when: false
      tags: ['mariadb']

    - name: Install prerequisite packages
      apt:
        name:
          - curl
          - gnupg
          - software-properties-common
          - python3-pymysql
        state: present
      tags: ['mariadb']

    - name: Download MariaDB repo setup script
      get_url:
        url: "https://downloads.mariadb.com/MariaDB/mariadb_repo_setup"
        dest: "/tmp/mariadb_repo_setup"
        mode: '0755'
      tags: ['mariadb']

    - name: Add official MariaDB {{ mariadb_version }} repository
      command: >
        bash /tmp/mariadb_repo_setup
        --mariadb-server-version=mariadb-{{ mariadb_version }}
        --skip-maxscale
        --skip-tools
      args:
        creates: /etc/apt/sources.list.d/mariadb.list
      tags: ['mariadb']

    - name: Update apt cache after adding MariaDB repository
      command: apt-get update
      changed_when: false
      tags: ['mariadb']

    - name: Install MariaDB server and client
      apt:
        name:
          - mariadb-server
          - mariadb-client
        state: present
      tags: ['mariadb']

    - name: Enable and start MariaDB service
      systemd:
        name: mariadb
        state: started
        enabled: true
        daemon_reload: true
      tags: ['mariadb']

    - name: Wait for MariaDB to be ready
      wait_for:
        port: "{{ mariadb_port }}"
        host: 127.0.0.1
        timeout: 30
      tags: ['mariadb']

    - name: Set MariaDB root password (using unix_socket auth)
      mysql_user:
        login_unix_socket: /run/mysqld/mysqld.sock
        name: root
        host: localhost
        password: "{{ mariadb_root_password }}"
        check_implicit_admin: true
        state: present
      ignore_errors: true
      tags: ['mariadb']

    - name: Remove anonymous MariaDB users
      mysql_user:
        login_unix_socket: /run/mysqld/mysqld.sock
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        name: ''
        host_all: true
        state: absent
      ignore_errors: true
      tags: ['mariadb']

    - name: Remove MariaDB test database
      mysql_db:
        login_unix_socket: /run/mysqld/mysqld.sock
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        name: test
        state: absent
      ignore_errors: true
      tags: ['mariadb']

    - name: Disallow remote root login
      mysql_user:
        login_unix_socket: /run/mysqld/mysqld.sock
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        name: root
        host: "{{ item }}"
        state: absent
      loop:
        - "{{ ansible_facts['hostname'] }}"
        - "127.0.0.1"
        - "::1"
        - "%"
      ignore_errors: true
      tags: ['mariadb']

    - name: Create admin user with remote access
      mysql_user:
        login_unix_socket: /run/mysqld/mysqld.sock
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        name: "{{ mariadb_admin_user }}"
        host: "%"
        password: "{{ mariadb_admin_password }}"
        priv: "*.*:ALL,GRANT"
        state: present
      tags: ['mariadb']

    - name: Configure MariaDB bind address and port
      ini_file:
        path: /etc/mysql/mariadb.conf.d/50-server.cnf
        section: mysqld
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        mode: '0644'
      loop:
        - { option: 'bind-address', value: '{{ mariadb_bind_address }}' }
        - { option: 'port', value: '{{ mariadb_port }}' }
      notify: Restart MariaDB 
      tags: ['mariadb']

    - name: Print MariaDB version
      command: mariadb --version
      register: mariadb_ver
      changed_when: false
      tags: ['mariadb']

    - name: Show installed MariaDB version
      debug:
        msg: "{{ mariadb_ver.stdout }}"
      tags: ['mariadb']

  handlers:
    - name: Restart MariaDB
      systemd:
        name: mariadb
        state: restarted
